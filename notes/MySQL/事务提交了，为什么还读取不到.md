背景

```sql
CREATE TABLE `fan` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) NOT NULL COMMENT '(被关注)用户ID',
  `anchor_flag` tinyint(4) DEFAULT '0' COMMENT '被关注用户主播标识0-普通用户;1-主播',
  `fan_user_id` bigint(20) NOT NULL COMMENT '粉丝用户ID',
  `del_flag` tinyint(4) DEFAULT '0' COMMENT '是否删除0-未删除;1-已删除',
  `created_at` datetime DEFAULT NULL,
  `updated_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `UNQ_USER_ID_FAN_USER_ID` (`user_id`,`fan_user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1013670 DEFAULT CHARSET=utf8mb4 COMMENT='粉丝关注'
```



1.第一个事务都提交了，但是第二个事务没查出来 然后第二个事务再插入的时候，数据库报唯一索引重复



REPEATABLE_READ

insert 





解决方案

1.提高隔离级别至SERIALIABLE，能解决？ 死锁

2.SELECT XX LOCK IN SHAR MODE;



第二个案例，场景类似，提高隔离级别后，偶尔出现死锁。。。。。



问题：Spring是怎么实现事务传播的管理的，难道通过将不同的SQL放在不同的connection上？

那这样的每个请求 或者线程中的方法是需要跟connect映射起来的？？？？？









