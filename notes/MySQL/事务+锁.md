> MySQL利用MVVC(MVVC又是依据undo log实现的)，在一个可重复读的事务执行过程中，读取到的数据都是事务开始时获取的快照，实现了事务见的隔离。
>
> 而在锁部分，MySQL更新一条数据会获取当前行的写锁，防止其他事务对当前行的并发更新。
>
> 问题：如果获取到锁后，当前事务看到的结果是更新后的还是更新前的？？？



结合下面案例，详细了解之

背景：REPEATABLE_READ， autocommit=1

表的定义如下

```sql
CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `k` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;
insert into t(id, k) values(1,1),(2,2);
```



| 事务A                                       | 事务B                                                        | 事务 C                         |
| ------------------------------------------- | ------------------------------------------------------------ | ------------------------------ |
| start transaction with consistent snapshot; |                                                              |                                |
|                                             | start transaction with consistent snapshot;                  | update t set k=k+1 where id=1; |
|                                             | update t set k=k+1 where id=1; <br/>select k from t where id=1; |                                |
| select k from t where id=1; <br/>commit;    |                                                              |                                |
|                                             | commit;                                                      |                                |



>关于事务启动的时机
>
>begin`或者`start transaction `后面第一条SQL执行时才会开启事务
>
>start transacton with consistent snapshot`会立即开启事务

在上面的流程中，事务A读到的是1；事务B读到的是3。根据MVVC，可重复读隔离级别下，事务A中读到的k是1，可以理解，同理，事务B中在更新时读到的也是1，更新后，再次读到应该是2才对呀。基于这个问题，再深入了解MVVC机制到底是怎么运作的。

在MySQL中，有两个“视图”的概念：

* 一个是view,用于查询时定义的虚拟表，创建视图的语法是`create view;`视图的查询方法与表的查询方法一致。

* 另一个是InnoDB实现MVVC用到的一致性读视图，即consistent read view,用于实现在READ_COMMITED和REPEATABLE_READ隔离级别下，每次读到的都是指定的“快照”。

  

  怎么指定只读事务，本质是什么，只读事务和不开启事务有何区别？

  

  

  再看事务





**只读事务**

怎么指定只读事务，本质是什么，只读事务和不开启事务有何区别？

```mysql
set session transaction read only;//只读事务
set session transaction read write;//读写事务
```





更新数据都是“先读后写”，读到的都是最新的值，称之为“当前读”。













> SERIALIABLE 隔离级别下的select 和 select lock in share mode 有何异同
>
> 