MySQL逻辑架构

![MySQL-archive.png](https://i.loli.net/2019/10/14/Xyq3mLhB542WwMU.png)



类似于把大象装进冰箱需要几步，我们看看从数据库查询一条数据需要几步

例如SQL：`select * from user where id=100 `

1.建立连接

连接器负责跟客户端建立连 接、获取权限、维持和管理连接。连接器会收回长时间空闲的连接，控制参数`wait_timeout`,默认是8小时，如果客户端在一个已经断开的连接上发送请求，会收到'Lost connection to MySQL server during query' 错误提示。

> 问题：数据库连接池框架是怎么管理连接的超时与否的？我的理解，在创建一个连接后，根据MySQL的wait_timeout值，在这之前就将此连接回收掉。



2.查询缓存，如果命中就直接返回缓存中的数据

> 缓存是存在内存中KV，其中K就是原始SQL语句？如果两条SQL只是空格不一样，关键字的大小写不一致，是否是同一个K？

> 问题：怎么查看MySQL的缓存命中率，如何判断命中率的高低，如果低了怎么优化提高命中率



3.解析SQL

如果没有命中缓存，则开始真正的查询流程。

词法分析：识别查询类别，select ，update等；识别表；识别字段

语法分析：根据词法分析结果，校验SQL语法



4.优化SQL，生成执行计划

根据需要，优化器会优化SQL，优化的点包括

如果有多个索引，选择合适的索引；

如果多表join，决定各表的连接顺序



5.执行SQL

a.校验是否有该表的查询权限

b.用该表定义的引擎打开表

> 打开表本质上是在操作什么？

c.根据条件遍历表，如果可以走索引，先查询索引

> 遍历是根据引擎提供的遍历接口实现的，将符合条件的结果加入到结果集，遍历的次数便是`rows_examined`



**实战**

如果表t中没有字段k,那么执行`select * from t where k=1;` ，会报错：Unknown column ‘k’ in ‘where clause。问这个错误是在哪个阶段报出来的？

答：解析SQL之校验语法的阶段？
